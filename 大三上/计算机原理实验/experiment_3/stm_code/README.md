# STM32 Experiment 3 - 中断控制实验

## 项目概述

本项目实现了基于STM32F4的中断控制系统，包括数码管显示、红绿灯控制和LED顺序点亮功能。

## 硬件配置

### GPIO配置

#### 输出引脚
- **LED灯** (PF0-PF7): 8个LED灯，高电平点亮
- **红绿灯组1** (PF8-PF10): R1, Y1, G1
- **红绿灯组2** (PF11-PF13): R2, Y2, G2
- **74HC595控制** (PC0-PC2): SI, RCK, SCK
- **74HC138控制** (PC3-PC5): A, B, C

#### 输入引脚（中断）
- **PB9**: GPIO_EXTI9，高电平有效（已消抖）
- **PB12**: GPIO_EXTI12，高电平有效（已消抖）

### 系统配置
- 主频: 82MHz
- 定时器: TIM3（用于时基，不使用中断）

## 功能实现

### 1. 默认模式 - 数码管计数

在没有中断触发时，系统执行以下操作：
- 使用74HC595和74HC138控制一位数码管
- 显示0-9循环计数
- 每秒变化一次

#### 74HC595工作流程
```
1. 拉低SCK（移位时钟），准备输入1位数据
2. 给SI输入1位段码数据（从高位到低位）
3. 拉高SCK，将SI的数据移入HC595的移位寄存器
4. 重复1-3，直到8位段码全部移入
5. 拉高RCK（锁存时钟），将移位寄存器的数据锁存到输出端（Q0-Q7）
```

### 2. PB12中断 - 红绿灯交替闪烁

当PB12按下时：
- 触发EXTI15_10中断
- 两组红绿灯以0.25秒（250ms）交替闪烁
- 持续时间: 3秒
- 中断期间暂停数码管显示

#### 闪烁模式
- 第1个250ms: 红绿灯组1点亮，组2熄灭
- 第2个250ms: 红绿灯组2点亮，组1熄灭
- 循环12次（共3秒）

### 3. PB9中断 - LED顺序点亮（抢占）

当PB9按下时：
- 触发EXTI9_5中断
- **抢占PB12中断**（优先级更高）
- 每0.1秒（100ms）点亮一个LED
- 从LED1到LED8依次点亮
- 全部点亮后中断结束

#### 点亮顺序
```
t=0ms:    LED1点亮
t=100ms:  LED1-2点亮
t=200ms:  LED1-3点亮
...
t=700ms:  LED1-8全部点亮（中断结束）
```

## 代码结构

### 主要函数

#### `HC595_SendByte(uint8_t data)`
向74HC595发送8位数据
- 参数: data - 要发送的8位段码
- 功能: 通过SI、SCK、RCK控制数据传输

#### `HC138_SelectDigit(uint8_t digit)`
使用74HC138选择数码管位
- 参数: digit - 位选择（0-7）
- 功能: 通过A、B、C控制位选信号

#### `Display_Digit(uint8_t digit)`
显示单个数字
- 参数: digit - 要显示的数字（0-9）
- 功能: 组合HC595和HC138显示数字

#### `Traffic_Light_Task(void)`
红绿灯闪烁任务
- 在主循环中被调用
- 根据时间控制红绿灯状态
- 3秒后自动结束

#### `LED_Sequential_Task(void)`
LED顺序点亮任务
- 在主循环中被调用
- 每100ms点亮一个LED
- 全部点亮后结束

#### `HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)`
GPIO外部中断回调函数
- 处理PB9和PB12的中断
- 设置中断标志位
- 关闭其他外设

## 中断优先级与抢占

### 中断优先级设置
- PB9 (EXTI9_5): 优先级 0,0（最高）
- PB12 (EXTI15_10): 优先级 0,0（相同，但PB9可以抢占）

### 抢占机制
当PB12中断正在执行（红绿灯闪烁）时，如果PB9被按下：
1. `pb9_interrupt_active` 标志位置1
2. `pb12_interrupt_active` 标志位清0
3. 红绿灯全部熄灭
4. 开始LED顺序点亮
5. LED任务完成后，不会恢复红绿灯任务

### 主循环优先级
```c
if (pb9_interrupt_active) {
    LED_Sequential_Task();
    continue;  // 最高优先级
}

if (pb12_interrupt_active) {
    Traffic_Light_Task();
    continue;  // 次高优先级
}

// 默认：数码管显示
Display_Digit(current_digit);
```

## 七段数码管段码表（共阴极）

| 数字 | 段码 (HEX) | 二进制 | 显示段 |
|------|------------|--------|--------|
| 0 | 0x3F | 0011 1111 | abcdef |
| 1 | 0x06 | 0000 0110 | bc |
| 2 | 0x5B | 0101 1011 | abdeg |
| 3 | 0x4F | 0100 1111 | abcdg |
| 4 | 0x66 | 0110 0110 | bcfg |
| 5 | 0x6D | 0110 1101 | acdfg |
| 6 | 0x7D | 0111 1101 | acdefg |
| 7 | 0x07 | 0000 0111 | abc |
| 8 | 0x7F | 0111 1111 | abcdefg |
| 9 | 0x6F | 0110 1111 | abcdfg |

段位排列: gfedcba (bit7-bit0)

## 使用说明

1. `make`+`./flash.sh`(需要安装probe-rs)
2. 上电后，数码管自动开始0-9循环计数
3. 按下PB12，触发红绿灯交替闪烁3秒
4. 在红绿灯闪烁期间按下PB9，立即停止红绿灯，开始LED顺序点亮
5. LED全部点亮后，系统返回数码管显示模式
