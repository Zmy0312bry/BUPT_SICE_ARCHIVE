# STM32双RAM控制系统

基于STM32F407的双RAM读写控制系统，通过FPGA实现双端口RAM，使用数码管显示，拨码开关控制，支持数据读写和异或运算。

## 项目概述

本项目实现了一个完整的嵌入式系统，包含：
- 双RAM（通过FPGA）的读写控制
- 8位数码管动态扫描显示
- LED状态指示
- 拨码开关输入
- 按钮中断处理
- 异或运算功能

## 硬件要求

- **主控**: STM32F407开发板（主频82MHz）
- **FPGA**: 已烧录`dual_ram.v`模块的FPGA开发板
- **显示**: 8位共阴数码管
- **驱动IC**: 74HC595（段选）、74HC138（位选）
- **指示**: 8个LED（PB0-PB7）
- **输入**: 8位拨码开关（PC0-PC7）、2个按钮（PC9, PC12）

## 功能特性

### 1. 模式控制
- **SW0**: 控制读出/写入模式
  - 0: 读出模式（LED0亮）
  - 1: 写入模式（LED0和LED1亮）

### 2. RAM选择
- **SW1**: 选择操作的RAM
  - 0: RAM0（LED2亮）
  - 1: RAM1（LED3亮）

### 3. 数据输入
- **SW2/SW3**: 配置2位待写入数据（0-3）
- 实时显示在数码管第8位

### 4. 地址控制
- **SW4/SW5**: 配置地址（0-3）
- 通过LED4/LED5以二进制显示

### 5. 数码管显示
显示格式：`[R0b1][R0b0].[R1b1][R1b0]`
- 位1-2: RAM1数据（二进制）
- 位3-4: RAM0数据（二进制，带小数点）
- 位8: 待写入数据

### 6. 按钮功能
- **按钮0 (PC9)**: 写入数据到选定的RAM（需要写入模式）
- **按钮1 (PC12)**: 异或操作
  - 读取两个RAM的数据
  - 计算XOR结果
  - 写回到选定的RAM

## 快速开始

### 1. 硬件连接

#### FPGA连接（PF端口）
```
STM32 → FPGA
PF0-PF15 → 对应FPGA引脚（详见dual_ram.v）
```

#### 外设连接
```
PA0-PA2 → 74HC595 (SI, RCK, SCK)
PA3-PA5 → 74HC138 (A, B, C)
PB0-PB7 → LED1-8
PC0-PC7 → 拨码开关SW0-7
PC9, PC12 → 按钮0, 按钮1
```

### 2. 编译和烧录

```bash
cd stm_code
make clean
make all
# 使用ST-Link烧录生成的.bin或.hex文件
```

### 3. 基本操作示例

**写入数据到RAM0地址0：**
```
1. SW0=1 (写入模式)
2. SW1=0 (选择RAM0)
3. SW4=0, SW5=0 (地址0)
4. SW2=1, SW3=1 (数据3)
5. 按下按钮0
6. 切换SW0=0查看结果
```

**执行异或操作：**
```
假设 RAM0[0]=01, RAM1[0]=11
1. SW1=0 (结果写RAM0)
2. SW4=0, SW5=0 (地址0)
3. 按下按钮1
结果: RAM0[0] = 01 XOR 11 = 10
```

## 文档

- **[Core/README.md](Core/README.md)** - 详细的系统说明和硬件配置
- **[Core/ARCHITECTURE.md](Core/ARCHITECTURE.md)** - 代码架构和函数说明
- **[QUICK_START.md](QUICK_START.md)** - 快速使用指南和操作示例
- **[TEST_PLAN.md](TEST_PLAN.md)** - 完整的测试计划和用例

## 项目结构

```
stm_code/
├── Core/
│   ├── Inc/
│   │   ├── main.h              # 主头文件（引脚定义、函数声明）
│   │   ├── stm32f4xx_it.h      # 中断处理头文件
│   │   └── stm32f4xx_hal_conf.h
│   └── Src/
│       ├── main.c              # 主程序（所有功能实现）
│       ├── stm32f4xx_it.c      # 中断服务程序
│       └── ...
├── Drivers/                    # STM32 HAL库
├── dual_ram.v                  # FPGA双RAM模块（Verilog）
├── Makefile                    # 编译配置
├── README.md                   # 本文档
├── QUICK_START.md             # 快速开始指南
└── TEST_PLAN.md               # 测试计划
```

## 主要模块

### 74HC595/74HC138驱动
- 动态扫描8位数码管
- 1ms刷新周期，125Hz刷新率

### 双RAM控制
- 支持2位宽数据（0-3）
- 1位地址（0-1，但SW支持0-3）
- 独立的A/B端口控制

### LED指示系统
- 实时显示系统状态
- 地址、模式、RAM选择可视化

### 中断处理
- GPIO外部中断：按钮响应
- TIM4定时器中断：数码管扫描

## 技术规格

| 参数 | 值 |
|------|-----|
| MCU主频 | 82MHz |
| 定时器频率 | 1kHz (1ms) |
| 数码管刷新率 | 125Hz |
| RAM数据宽度 | 2位 |
| RAM地址宽度 | 1位 |
| 主循环周期 | ~50ms |

## 引脚分配速查表

### 输入
- PC0-PC7: 拨码开关SW0-SW7
- PC9: 按钮0（写入）
- PC12: 按钮1（异或）

### 输出
- PB0-PB7: LED0-LED7
- PA0-PA5: 数码管控制
- PF0-PF15: 双RAM接口

## 异或操作说明

异或运算真值表（2位）：
```
00 XOR 00 = 00    01 XOR 00 = 01
00 XOR 01 = 01    01 XOR 01 = 00
00 XOR 10 = 10    01 XOR 10 = 11
00 XOR 11 = 11    01 XOR 11 = 10
10 XOR 00 = 10    11 XOR 00 = 11
10 XOR 01 = 11    11 XOR 01 = 10
10 XOR 10 = 00    11 XOR 10 = 01
10 XOR 11 = 01    11 XOR 11 = 00
```

## 故障排除

### LED不亮
- 检查供电
- 检查PB端口连接
- 测试拨码开关响应

### 数码管不显示
- 检查74HC595/74HC138连接
- 验证数码管类型（共阴）
- 检查PA端口输出

### RAM读写异常
- 确认FPGA已烧录dual_ram.v
- 检查PF端口所有连接
- 使用逻辑分析仪查看时序

### 按钮无响应
- 确认PC9/PC12连接
- 检查按钮电平（高电平有效）
- 写入需要SW0=1

## 开发环境

- **编译器**: arm-none-eabi-gcc
- **构建系统**: GNU Make
- **烧录工具**: ST-Link / OpenOCD
- **调试工具**: GDB / ST-Link Utility
- **FPGA工具**: 根据FPGA型号选择

## 许可证

根据项目实际情况添加许可证信息。

## 作者

根据项目实际情况添加作者信息。

## 版本历史

### V1.0
- 初始版本
- 实现双RAM读写控制
- 实现数码管显示
- 实现LED指示和拨码开关输入
- 实现按钮中断和异或操作

## 贡献

欢迎提交Issue和Pull Request。

## 联系方式

如有问题，请通过Issue联系。

---

**注意**: 
1. 确保FPGA端的dual_ram.v模块已正确烧录
2. 注意电平匹配（STM32为3.3V）
3. 按钮已硬件消抖，软件添加20ms延时
4. RAM地址实际只支持0-1，虽然SW可设置0-3